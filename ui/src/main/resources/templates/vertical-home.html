<!DOCTYPE html>
<html th:lang="${siteLocale.language}">

<head>

	<!--/* Metas and CSS */-->
	<th:block th:insert="~{inc/header-meta.html}"></th:block>
    
	<!-- Primary Meta Tags -->
	<title th:text="#{index.title}"></title>
	<meta name="title" th:content="${config.i18n(siteLanguage).verticalMetaTitle}">
	<meta name="description" th:content="${config.i18n(siteLanguage).verticalMetaDescription}">
		
	<!-- Open Graph / Facebook -->
	<meta property="og:type" content="website">
	<meta property="og:url" th:content="${url}">
	<meta property="og:title" th:content="${config.i18n(siteLanguage).productMetaOpenGraphTitle}">
	<meta property="og:description" th:content="${config.i18n(siteLanguage).productMetaOpenGraphTitle}">
	<meta property="og:image" th:content="${url} + 'assets/img/brand/light.svg'">
	
	<!-- Twitter -->
	<meta name="twitter:card" content="summary_large_image">
	<!-- TODO : Image of the category -->
	<meta name="twitter:url" th:content="${url}">
	<meta name="twitter:title" th:content="${config.i18n(siteLanguage).productMetaTwitterTitle}">
	<meta name="twitter:description" th:content="${config.i18n(siteLanguage).productMetaTwitterDescription}">
	<!-- TODO : Image of the category -->
	<meta name="twitter:image" th:content="${url} + 'assets/img/brand/light.svg'">

	<link rel="stylesheet" type="text/css" href="/webjars/datatables/css/dataTables.bootstrap5.min.css">
	
	<style>
	tbody, td, tfoot, th, thead, tr {
    	 border-style: none;
	}	
	
	</style>
	
</head>

<body>
 	<!--/* Navbar */-->
	<th:block th:insert="~{inc/navbar/navbar-vertical.html}"></th:block>
    <!--/* Loader */-->
    <th:block th:insert="~{inc/preloader.html}"></th:block>
	
    <main>	
  
        <div class="section section-lg pt-5 pt-md-3 bg-gray-200">
            <div class="container container-semi-fluid">

				<!--/* Hero */-->						
				<div class="row mb-2">							
					<div class="card shadow">
						<div class=" align-items-center">
							
								<div class="d-flex flex-wrap align-items-center row">
			                        <div class="col-lg-2 text-center">
			                                <img class="mt-2" width="150" th:src="'/images/verticals/' + ${vertical} + '.png'">
			                        </div>
			                        <div class="col-lg-10">
			                                <h1 class="mt-2 text-center" th:text="${config.i18n(siteLanguage).verticalHomeTitle}"></h1>
			                                <p class="row p-2 mb-4" th:text="${config.i18n(siteLanguage).verticalHomeDescription}"> </p>		
			                				
			                        </div> 
								</div>
	                    </div>
					</div>
				</div>
						
                <div class="row ">
                
                	<!--/* Left column */-->                	
                    <div class="col-lg-3 mb-3 mb-lg-0">
                    
                		<!--/* Guides */-->	
						<div th:if="${config.i18n(siteLanguage).getWikiPages().size() > 0}" class="row card shadow mb-2">
							<div class="card-header"><h2 class="h5">Les guides</h2></div>
							<div class="card-body">
								<ul class="list-group list-group-flush price-list">
									<li th:each="item : ${config.i18n(siteLanguage).getWikiPages()}" class="list-group-item border-0">
										<span class="fas" th:classappend="${item.faIcon}" ></span>
										<a th:href="'/' + ${verticalPath} + '/'+ ${item.verticalUrl}" th:text="${item.title}"></a> 
									</li>								
								</ul>
							</div>
						</div>   
						

                		<!--/* Blog posts */-->	
						<div th:if="${posts.size()>0}" class="row card shadow mb-2">
							<div class="card-header"><h2 class="h5">On en parle dans le blog</h2></div>
							<div class="card-body">
								<ul class="list-group list-group-flush price-list">
									<li th:each="post : ${posts}" class="list-group-item border-0">										
										<a th:href="'/blog/'+${post.url}" th:text="${post.title}"></a> 
									</li>
								</ul>
							</div>
						</div>   
						

						
						                 
                                        
				        <!--/* Ecological Filters */-->	
						<div class="row card shadow mb-2 border-success text-secondary">
							<div class="card-header"><h2 class="h5">Eco-Filtres</h2></div>
							<div class="card-body">
                    			<th:block th:insert="~{inc/vertical-filters-eco.html}"></th:block>
								
							</div>
						</div>

				        <!--/* Classical Filters */-->							
						<div class="row card shadow mb-2">
							<div class="card-header"><h2 class="h5">Filtres</h2></div>
							<div class="card-body">
                    			<th:block th:insert="~{inc/vertical-filters.html}"></th:block>
								
							</div>
						</div>
						
						
						  				        					
					</div>

					<!--/* Right column */-->
					<div class="col-lg-9">
						<div class="ms-1 row card shadow">
							<th:block th:insert="~{inc/vertical-table.html}"></th:block>
						</div>

					</div>
				</div>
        	</div>
       	</div>
    </main>

	<!--/* Footer */-->
	<th:block th:insert="~{inc/footer.html}"></th:block>	

<!-- Core -->
<script src="../../vendor/@popperjs/core/dist/umd/popper.min.js"></script>
<script src="/webjars/bootstrap/js/bootstrap.min.js"></script>
<script src="../../vendor/headroom.js/dist/headroom.min.js"></script>

<!-- Vendor JS -->

<script src="../../vendor/smooth-scroll/dist/smooth-scroll.polyfills.min.js"></script>
<script src="../../vendor/vivus/dist/vivus.min.js"></script>
<script src="/webjars/jquery/jquery.min.js"></script>
<script src="../../vendor/@popperjs/core/dist/umd/popper.min.js"></script>

<script type="text/javascript" language="javascript" src="/webjars/datatables/js/dataTables.min.js"></script>
<script type="text/javascript" language="javascript" src="/webjars/datatables/js/dataTables.bootstrap5.min.js"></script>

<script src="../../vendor/nouislider/distribute/nouislider.min.js"></script>

<!-- pixel JS -->
<script src="../../assets/js/pixel.js"></script>

<!-- custom sources -->
<script src="../../assets/js/pixel-custom.js"></script>

<script src="/webjars/mustache/mustache.min.js"></script>



<!-- Ajax loaded table template -->
<div id="tpl_place" class="hidden"></div>

<!-- Setting up variables -->
<script th:inline="javascript">
	/*<![CDATA[*/
	
	    const vertical = /*[[${config.id}]]*/ '';
	    const siteLanguage = /*[[${siteLanguage}]]*/'';
	    const baseUrl = /*[[${baseUrl}]]*/'';
	    const verticalPath = /*[[${verticalPath}]]*/'';
	    const additionalAttributes = /*[[${filters}]]*/'';
	    const tpl = /*[[${tpl}]]*/'';
	    
	    
	    	    	    
	/*]]>*/
</script>

<script>

   var dummyRender = function(cell, type, data) {return  "" ;}
   
   function description (data) {
   	
   	if (data.genaiTexts == null) {
   		return "";
   	}
   	
   	// TODO : I18n
   	// TODO : Ugly, ugly....
   	if (data.genaiTexts['fr'] == null) {
        return "";
    }
   	

   	if (data.genaiTexts['fr'].descriptions['ecological-description'] != null) {
   		ret = data.genaiTexts['fr'].descriptions['ecological-description'].content;
   		
   		if (ret == null) {
   		   return "";
   		}
   		
   		if (ret.length > 200) {
   			return ret.slice(0, 200) + "...";
   		} else {
   		    return ret;
   		}
   	} 
   	
   	return "";
   }
   
   
   var columns = [
       { 
       	"data": "attributes.referentielAttributes.MODEL", 
       	"name" : "Modèle",
       	"title" : "Modèle",
       	render: function(cell, type, data) {
				var template = $('#template-product-search').html();
				Mustache.parse(template);

				return Mustache.render(template, {
					data : data,
					vertical: vertical,
  					productUrl : baseUrl+verticalPath+'/'+data.names.url['default'],
  					ecoscore: Math.round((data.scores.ECOSCORE.value + Number.EPSILON) * 100) / 100 ,
  					compensation: Math.round((data.price.minPrice.compensation + Number.EPSILON) * 100) / 100 ,
  					
  					
// TODO : Default as a hack until full i18n is implemented
  					desc:   description(data),
  					imageUrl : (data.coverImagePath),           					
					name : (data.attributes.referentielAttributes.MODEL == null ? data.names.name : data.attributes.referentielAttributes.MODEL)
				});                	
       	}
       },
       
       { 
       	"data": "attributes.referentielAttributes.BRAND", 
       	"name" : "Marque",
       	"title" : "Marque",
       	render: function(cell, type, data) {
               return  "" ;
           }
       },
       { "data": "scores.ECOSCORE.value", "name" : "Ecoscore", "title" : "Ecoscore"  },
       { "data": "price.minPrice.price", "name" : "Prix", "title" : "Prix"  },
       { "data": "offersCount", "name" : "Concurrence", "title" : "Concurrence"  }
           ];

	 	for ( i = 0; i <  additionalAttributes.length; i++) {						
			columns[i+5] = JSON.parse('{ "data": "attributes.aggregatedAttributes.'+additionalAttributes[i]['key']+'.value", "name" : "'+additionalAttributes[i]['name'][siteLanguage]+'", "title" : "'+additionalAttributes[i]['name'][siteLanguage]+'"  }');
			columns[i+5].render = dummyRender;
	 	}
	 
	<!-- Datatable init function -->
	var table;
	
	function initDatatable () {
		
		return $('#tableProducts').DataTable({
			
			order: [ [2, 'desc'] ],
	    	searching: false,
	        "bLengthChange": false,	 
	        "processing": true,
	        "serverSide": true,
	        "orderMulti": false,
	        "pageLength": 5,
	        "ajax": {
	            "url": "/"+verticalPath+"/paginated",
	            "dataSrc": "data",
	            "data": function ( data ) {
	            	// Adding slider rangers attributes
	            	var sliderParameters = new Array();
	            	$('.input-slider-range-container').each (function (e) {
	            		sliderParameters.push( $(this).attr("id") + ":" + $(this).attr('data-range-value-min') + " : " + $(this).attr('data-range-value-max'));	            		
		            	} 
	            	);	            	
	            	data.sliders=sliderParameters;
	            	
	            	// Adding checkboxes attributes
	            	var checkboxesParameters = new Array();
	            	$('input:checked').each (function (e) {	            	
	            		checkboxesParameters.push( $(this).attr("id"));	            				            	
	            		} 
	            	);	
	            	data.checkboxes=checkboxesParameters;

	 				return data;
	         }},
	         
	         createdRow: function(row, data, dataIndex){
	                 // Add COLSPAN attribute
	                 $('td:eq(0)', row).attr('colspan', 9);	                 
					 for ( i = 1; i < 5+ additionalAttributes.length; i++) {						
	                 	$('td:eq('+i+')', row).css('display', 'none');
					 }
	         },
	         
	        "columns": columns 
	 	});
	};

	// On document Load
	$(document).ready(function() {
		
		// Loading templates 
		$.ajax({
			url : '/tpl_table'+tpl+'.html',
			dataType : 'html',
			cache : true, // otherwise will get fresh copy every page load
			success : function(e) {
				// script loaded, do stuff!
				$("#tpl_place").html(e);

				// Init table 			
	    		table = initDatatable();
			}
		});
				
		// Range sliders listener
		var slidersCounter = $('.input-slider-range-container').length;
	    $('.input-slider-range-container').on('change', function(e) {
	    		    	
	    	// this change function is called on page load (component js init)
	    	// This counter ensure the datatble is not drawn on page load
	    	if (slidersCounter <= 0) {	    		
				table.draw();				
	    	} else {
	    		slidersCounter--;
	    	}
	    	
		});

	    // Checkboxes listener
	    $('input:checkbox').click(function() { 
			table.draw();					    	
	   	});
		
	} );
</script>

</body>

</html>
