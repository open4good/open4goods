name: Assign Issues to GitHub Projects V2

on:
  issues:
    types: [labeled]

env:
  ORG_NAME: open4good
  PROJECT_ID_MAPPING: |
    squad:ux=PVT_kwDOBOJOp84A2ZRZ
    squad:backend=PVT_kwDOBOJOp84A8xdZ
    squad:exposition=PVT_kwDOBOJOp84A8xdy
    squad:pmo=PVT_kwDOBOJOp84A8tDc
    EPIC=PVT_kwDOBOJOp84A8tDc

jobs:
  assign-to-project:
    if: github.event.action == 'labeled'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.PROJECT_PAT }}
          script: |
            const mapping = Object.fromEntries(
              process.env.PROJECT_ID_MAPPING
                .trim()
                .split('\n')
                .map(line => line.trim().split('='))
            );
            const labelName = context.payload.label.name;
            const projectId = mapping[labelName];
            if (!projectId) {
              console.log(`No project configured for label '${labelName}', skipping.`);
              return;
            }
            await github.graphql(
              `
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: { projectId: $projectId, contentId: $contentId }) {
                  item { id }
                }
              }
              `,
              { projectId, contentId: context.payload.issue.node_id }
            );
            console.log(`Issue #${context.payload.issue.number} added to project ID ${projectId}.`);