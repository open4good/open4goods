name: Add issue to GitHub Project (Beta) on label

on:
  issues:
    types: [labeled]

jobs:
  add-to-project-beta:
    runs-on: ubuntu-latest
    steps:
      - name: Get ProjectV2 ID (org-level)
        id: get_project
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const label = context.payload.label.name;
            if (label !== 'squad:ux') {
              console.log(`Label "${label}" ignor√©.`);
              return;
            }

            const query = `
              query($org: String!, $number: Int!) {
                organization(login: $org) {
                  projectV2(number: $number) {
                    id
                  }
                }
              }`;

            const result = await github.graphql(query, {
              org: "open4good",
              number: 4
            });

            const projectId = result.organization?.projectV2?.id;
            if (!projectId) {
              throw new Error("‚ùå Impossible de r√©cup√©rer l'ID du ProjectV2.");
            }

            console.log(`üìå ProjectV2 ID : ${projectId}`);
            return projectId;

      - name: Add issue to Project (Beta)
        if: steps.get_project.outputs.result != ''
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const projectId = '${{ steps.get_project.outputs.result }}';
            const issueId = context.payload.issue.node_id;

            const mutation = `
              mutation($projectId: ID!, $contentId: ID!) {
                addProjectV2ItemById(input: {
                  projectId: $projectId,
                  contentId: $contentId
                }) {
                  item {
                    id
                  }
                }
              }`;

            const result = await github.graphql(mutation, {
              projectId: projectId,
              contentId: issueId
            });

            console.log(`‚úÖ Issue ajout√©e au Project (Beta) avec item ID : ${result.addProjectV2ItemById.item.id}`);