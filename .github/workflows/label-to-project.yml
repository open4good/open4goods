name: Auto add issue to GitHub Project when labeled

on:
  issues:
    types: [labeled]

jobs:
  add-to-project:
    runs-on: ubuntu-latest
    steps:
      - name: Add issue to classic project based on label (with debug)
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // 🛠️ CONFIG : labels => project IDs (classic only)
            const labelToProjectMap = {
              'squad:ux': 4
            };

            const label = context.payload.label.name;
            const issue = context.payload.issue;

            const projectId = labelToProjectMap[label];
            if (!projectId) {
              console.log(`Aucun projet associé au label "${label}".`);
              return;
            }

            console.log(`🔍 Tentative d'ajout de l'issue #${issue.number} au projet ${projectId}.`);

            // Récupération des colonnes
            const columnsResponse = await github.rest.projects.listColumns({
              project_id: projectId
            });

            const columns = columnsResponse.data;
            console.log(`🧱 ${columns.length} colonne(s) détectée(s) dans le projet :`);
            for (const col of columns) {
              console.log(` - ${col.name} (ID: ${col.id})`);
            }

            const noStatusColumn = columns.find(c => c.name === 'No Status');
            if (!noStatusColumn) {
              throw new Error(`❌ Colonne "No Status" introuvable dans le projet ${projectId}.`);
            }

            console.log(`✅ Colonne "No Status" trouvée avec ID: ${noStatusColumn.id}. Création de la carte...`);

            await github.rest.projects.createCard({
              column_id: noStatusColumn.id,
              content_id: issue.id,
              content_type: 'Issue'
            });

            console.log(`🎉 Carte créée dans la colonne "No Status" du projet ${projectId}.`);
