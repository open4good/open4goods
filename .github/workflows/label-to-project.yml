# .github/workflows/assign-issues-to-projects.yml
name: Assign Issues to GitHub Projects (beta)

on:
  issues:
    types: [labeled]

env:
  # Configure your label-to-project mapping here.
  # To get the GraphQL project V2 ID for project number 4, you can run:
  # {
  #   organization(login: "open4good") {
  #     projectV2(number: 4) { id }
  #   }
  # }
  PROJECT_MAPPING: '{"squad:ux":"PVT_PROJECT_V2_XXXXXXXXXXXXXXXX"}'

jobs:
  assign-to-project:
    if: github.event.action == 'labeled'
    runs-on: ubuntu-latest
    steps:
      - name: Add issue to project based on label
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const labelName = context.payload.label.name;
            const mapping = JSON.parse(process.env.PROJECT_MAPPING);
            const projectId = mapping[labelName];
            if (!projectId) {
              core.info(`No project configured for label '${labelName}', skipping.`);
            } else {
              const contentId = context.payload.issue.node_id;
              await github.graphql(
                `
                mutation($projectId: ID!, $contentId: ID!) {
                  addProjectV2Item(input: { projectId: $projectId, contentId: $contentId }) {
                    item { id }
                  }
                }
                `,
                { projectId, contentId }
              );
              core.info(`Issue added to project ${projectId} for label '${labelName}'.`);
            }
