name: üöÄ Release

# Config: set the regex controlling which tags may trigger the cloud deploy workflow.
# By default only tags containing "cloud" or "point-cloud" are allowed.
env:
  CLOUD_TAG_REGEX_DEFAULT: "^refs/tags/.*(cloud|point-cloud).*$"

on:
  push:
    tags:
      - "*"
  workflow_dispatch:
    inputs:
      ref:
        description: "Tag/branch/SHA √† d√©ployer (ex: v1.2.3). Laisse 'main' pour la branche principale."
        required: true
        default: "main"
        type: string
      mode:
        description: "Mode d'ex√©cution (release ou test)"
        required: false
        default: release
        type: choice
        options: [release, test]
      cloud_tag_regex:
        description: "Expression r√©guli√®re autorisant le d√©clenchement (par d√©faut: tags cloud/point-cloud)"
        required: false
        default: "^refs/tags/.*(cloud|point-cloud).*$"
        type: string
      bypass_tag_filter:
        description: "Ignorer le filtre cloud (true pour forcer l'ex√©cution)"
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  release:
    if: |
      (github.event_name == 'workflow_dispatch' && inputs.bypass_tag_filter == true) ||
      (github.event_name == 'workflow_dispatch' && ((inputs.ref || '') matches (inputs.cloud_tag_regex || env.CLOUD_TAG_REGEX_DEFAULT))) ||
      (github.event_name != 'workflow_dispatch' && (github.ref matches env.CLOUD_TAG_REGEX_DEFAULT))
    runs-on: ubuntu-latest

    env:
      MODE: ${{ inputs.mode || 'release' }}
      CLOUD_TAG_REGEX: ${{ github.event_name == 'workflow_dispatch' && inputs.cloud_tag_regex || env.CLOUD_TAG_REGEX_DEFAULT }}

    concurrency:
      group: deploy-prod
      cancel-in-progress: true

    steps:
      ############################################
      # üß≠ Resolve ref & versioning
      ############################################
      - name: üß≠ Resolve refs & version
        id: meta
        shell: bash
        env:
          RAW_REF: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}
        run: |
          set -euo pipefail

          echo "checkout_ref=${RAW_REF}" >> "$GITHUB_OUTPUT"

          REF_NAME="${RAW_REF#refs/heads/}"
          REF_NAME="${REF_NAME#refs/tags/}"

          if [[ "${REF_NAME}" =~ ^[0-9a-f]{40}$ ]]; then
            REF_NAME="${REF_NAME:0:12}"
          fi

          SAFE_VERSION="$(echo "${REF_NAME}" | tr '/ ' '--')"

          echo "version=${REF_NAME}" >> "$GITHUB_OUTPUT"
          echo "safe_version=${SAFE_VERSION}" >> "$GITHUB_OUTPUT"

          if [[ "${RAW_REF}" == refs/tags/* ]]; then
            echo "is_tag=true" >> "$GITHUB_OUTPUT"
          else
            echo "is_tag=false" >> "$GITHUB_OUTPUT"
          fi

      ############################################
      # Checkout
      ############################################
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ steps.meta.outputs.checkout_ref }}

      ############################################
      # üóÇÔ∏è Prepare reports directories (target)
      ############################################
      - name: üóÇÔ∏è Prepare reports directories
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p frontend/public/reports/maven-site
          mkdir -p frontend/public/reports/releases
          mkdir -p frontend/public/reports/test-coverage/backend
          mkdir -p frontend/public/reports/test-coverage/frontend



      ############################################
      # üìù Release Notes
      ############################################
      - name: üìù Build Release Notes (tag)
        id: build_changelog
        if: steps.meta.outputs.is_tag == 'true'
        uses: mikepenz/release-changelog-builder-action@v6.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          fetchReleaseInformation: true
          outputFile: RELEASE-NOTES.md
          configurationJson: |
            {
              "sort": { "order": "ASC", "on_property": "mergedAt" },
              "template": "## ü•≥ Welcome to **#{{TO_TAG}}**\n\nThis release covers **#{{DAYS_SINCE}} day(s)** of work, from **#{{FROM_TAG_DATE}}** to **#{{TO_TAG_DATE}}**.\n\n### üì¶ Stats\n- Diff: [compare](#{{RELEASE_DIFF}})\n- Changed files: **#{{CHANGED_FILES}}**\n- Commits: **#{{COMMITS}}**\n- Additions: **#{{ADDITIONS}}** / Deletions: **#{{DELETIONS}}**\n\n---\n\n#{{CHANGELOG}}\n\n<details>\n<summary>üôà Other changes (#{{UNCATEGORIZED_COUNT}})</summary>\n\n| PR | Title | Author |\n|---:|---|---|\n#{{UNCATEGORIZED}}\n\n</details>\n",
              "pr_template": "| [PR #{{NUMBER}}](#{{URL}}) | #{{TITLE}} | @#{{AUTHOR}} |",
              "empty_template": "Nothing",
              "label_extractor": [
                {
                  "pattern": "^(build|chore|ci|docs|feat|fix|perf|refactor|revert|style|test)(\\\\([^\\\\)]*\\\\))?(!)?:",
                  "on_property": "title",
                  "target": "$1",
                  "method": "match"
                },
                {
                  "pattern": "^(chore|fix)\\\\(deps\\\\):",
                  "on_property": "title",
                  "target": "deps",
                  "method": "match"
                }
              ],
              "transformers": [
                {
                  "pattern": "(^|[\\\\s\\\\(])#(\\\\d+)\\\\b",
                  "target": "$1[#$2](${{ github.server_url }}/${{ github.repository }}/issues/$2)",
                  "method": "replaceAll"
                }
              ],
              "categories": [
                { "title": "### ‚ú® Features\n\n| PR | Title | Author |\n|---:|---|---|", "labels": ["feat", "feature"] },
                { "title": "### üêõ Bug Fixes\n\n| PR | Title | Author |\n|---:|---|---|", "labels": ["fix", "bug"] },
                { "title": "### ‚ö° Performance\n\n| PR | Title | Author |\n|---:|---|---|", "labels": ["perf", "performance"] },
                { "title": "### üìö Documentation\n\n| PR | Title | Author |\n|---:|---|---|", "labels": ["docs", "documentation"] },
                { "title": "### üßπ Maintenance\n\n| PR | Title | Author |\n|---:|---|---|", "labels": ["chore", "refactor", "ci", "build", "test", "style"] },
                { "title": "### üß∞ Patch management\n\n| PR | Title | Author |\n|---:|---|---|", "labels": ["deps", "dependencies", "patch-management"] }
              ]
            }

      - name: üìù Build Release Notes (fallback, non-tag)
        if: steps.meta.outputs.is_tag != 'true'
        shell: bash
        run: |
          set -euo pipefail
          LAST_TAG="$(git describe --tags --abbrev=0 2>/dev/null || true)"
          {
            echo "## Release notes for \`${{ steps.meta.outputs.version }}\`"
            echo ""
            if [[ -n "${LAST_TAG}" ]]; then
              echo "_Since ${LAST_TAG}_"
              echo ""
              git log --pretty=format:"- %s (%an)" "${LAST_TAG}..HEAD" || true
            else
              echo "_Last commits_"
              echo ""
              git log -n 50 --pretty=format:"- %s (%an)" || true
            fi
            echo ""
          } > RELEASE-NOTES.md

      - name: üìå Write release notes into frontend/public/reports/releases
        shell: bash
        env:
          SAFE_VERSION: ${{ steps.meta.outputs.safe_version }}
        run: |
          set -euo pipefail
          cp RELEASE-NOTES.md "frontend/public/reports/releases/${SAFE_VERSION}.md"
          cp RELEASE-NOTES.md "frontend/public/reports/releases/latest.md"

      ############################################
      # Java / Maven (build + site + jacoco aggregate)
      ############################################
      - name: Set up JDK 25 (Temurin) + Maven cache
        uses: actions/setup-java@v5
        with:
          distribution: "temurin"
          java-version: "25"
          cache: "maven"

      - name: Set up Maven Repositories
        uses: s4u/maven-settings-action@v4.0.0
        with:
          repositories: |
            [
              {
                "id": "xwiki-releases",
                "name": "xwiki-releases",
                "url": "https://maven.xwiki.org/releases/",
                "snapshots": { "enabled": false }
              }
            ]

      - name: üß± Build & Test (Maven)
        shell: bash
        run: |
          set -euo pipefail
          mvn -B -ntp -T 1C -DinstallAtEnd=true clean install

      - name: üåê Generate Maven Site (stage)
        shell: bash
        run: |
          set -euo pipefail
          mvn -B -ntp -T 1C -DskipTests site site:stage

      - name: üßæ Copy Maven site & JaCoCo aggregate into frontend/public/reports
        shell: bash
        run: |
          set -euo pipefail

          MAVEN_SITE_SRC="target/staging"

          if [[ -d "target/site/jacoco-aggregate" ]]; then
            JACOCO_SRC="target/site/jacoco-aggregate"
          else
            JACOCO_SRC="target/site/jacoco"
          fi

          if [[ -d "${MAVEN_SITE_SRC}" ]]; then
            rsync -a --delete "${MAVEN_SITE_SRC}/" "frontend/public/reports/maven-site/"
          else
            echo "No Maven site staging directory found; skipping."
          fi

          if [[ -d "${JACOCO_SRC}" ]]; then
            rsync -a --delete "${JACOCO_SRC}/" "frontend/public/reports/test-coverage/backend/"
          else
            echo "No JaCoCo report directory found; skipping."
          fi

      ############################################
      # Frontend (tests coverage -> copy -> build)
      ############################################
      - name: Setup Node 24
        uses: actions/setup-node@v6
        with:
          node-version: "24"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.26.1

      - name: Setup pnpm cache
        uses: actions/setup-node@v6
        with:
          node-version: "24"
          cache: "pnpm"
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install dependencies
        working-directory: frontend
        run: pnpm install --frozen-lockfile

      - name: Run frontend tests with coverage
        working-directory: frontend
        run: pnpm test:coverage

      - name: üßæ Copy frontend coverage into frontend/public/reports
        shell: bash
        run: |
          set -euo pipefail
          SRC="frontend/app/artifacts/coverage/lcov-report"
          if [[ -d "${SRC}" ]]; then
            rsync -a --delete "${SRC}/" "frontend/public/reports/test-coverage/frontend/"
          else
            echo "No frontend coverage directory found at ${SRC}; skipping."
          fi



      - name: üîé Debug reports (what exists, where)
        shell: bash
        run: |
          set -euo pipefail

          echo "=== Maven/Jacoco candidates ==="
          find . -maxdepth 6 -type d \( \
            -path "*/target/staging*" -o \
            -path "*/target/site/jacoco*" \
          \) -print || true

          echo "=== Frontend coverage candidates ==="
          find frontend -maxdepth 8 -type d \( -name "lcov-report" -o -name "coverage" \) -print | head -n 200 || true

          echo "=== What got copied into frontend/public/reports ==="
          find frontend/public/reports -maxdepth 6 -type f -name "index.html" -print | head -n 200 || true
          du -sh frontend/public/reports || true



      - name: Build Nuxt (Node SSR)
        working-directory: frontend
        run: pnpm build
        env:
          API_URL: ${{ secrets.API_URL }}
          MACHINE_TOKEN: ${{ secrets.MACHINE_TOKEN }}
          HCAPTCHA_SITE_KEY: ${{ secrets.HCAPTCHA_SITE_KEY }}
          APP_ENV: production


      - name: üîé Verify Nuxt output contains reports
        shell: bash
        run: |
          set -euo pipefail
          test -d frontend/.output/public || (echo "No frontend/.output/public"; exit 1)
          find frontend/.output/public/reports -maxdepth 6 -type f -name "index.html" -print | head -n 200 || true
          du -sh frontend/.output/public/reports || true





      ############################################
      # üì¶ Always upload reports artifact (even in MODE=test)
      ############################################
      - name: üì¶ Upload reports artifact
        uses: actions/upload-artifact@v6
        with:
          name: reports-${{ steps.meta.outputs.safe_version }}
          path: frontend/public/reports

      ############################################
      # ‚úÖ main: release notes only
      ############################################
      - name: üìù Commit release notes to default branch (only)
        if: env.MODE != 'test'
        shell: bash
        env:
          DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          SAFE_VERSION: ${{ steps.meta.outputs.safe_version }}
          VERSION_DISPLAY: ${{ steps.meta.outputs.version }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin --prune

          MAIN_DIR="$(mktemp -d)"
          git worktree add "${MAIN_DIR}" "origin/${DEFAULT_BRANCH}"

          mkdir -p "${MAIN_DIR}/frontend/public/reports/releases"
          cp "frontend/public/reports/releases/${SAFE_VERSION}.md" "${MAIN_DIR}/frontend/public/reports/releases/${SAFE_VERSION}.md"
          cp "frontend/public/reports/releases/latest.md" "${MAIN_DIR}/frontend/public/reports/releases/latest.md"

          git -C "${MAIN_DIR}" add -f "frontend/public/reports/releases/${SAFE_VERSION}.md" "frontend/public/reports/releases/latest.md"
          if git -C "${MAIN_DIR}" diff --cached --quiet; then
            echo "Release notes already up to date on ${DEFAULT_BRANCH}."
          else
            git -C "${MAIN_DIR}" commit -m "chore: add release notes for ${VERSION_DISPLAY}"
            git -C "${MAIN_DIR}" push origin "HEAD:${DEFAULT_BRANCH}"
          fi

          git worktree remove "${MAIN_DIR}" --force

      ############################################
      # ‚úÖ tag: publish full reports to a dedicated branch reports/<tag>
      ############################################
      - name: üßæ Publish full reports to reports/<tag> branch
        if: env.MODE != 'test' && steps.meta.outputs.is_tag == 'true'
        shell: bash
        env:
          SAFE_VERSION: ${{ steps.meta.outputs.safe_version }}
          VERSION_DISPLAY: ${{ steps.meta.outputs.version }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin --prune

          REPORTS_BRANCH="reports/${SAFE_VERSION}"
          WT_DIR="$(mktemp -d)"

          if git ls-remote --exit-code --heads origin "${REPORTS_BRANCH}" >/dev/null 2>&1; then
            git worktree add "${WT_DIR}" "origin/${REPORTS_BRANCH}"
          else
            git worktree add -b "${REPORTS_BRANCH}" "${WT_DIR}" HEAD
          fi

          mkdir -p "${WT_DIR}/frontend/public/reports"
          rsync -a --delete "frontend/public/reports/" "${WT_DIR}/frontend/public/reports/"

          git -C "${WT_DIR}" add -f frontend/public/reports
          if git -C "${WT_DIR}" diff --cached --quiet; then
            echo "Reports branch already up to date."
          else
            git -C "${WT_DIR}" commit -m "chore: publish reports for ${VERSION_DISPLAY}"
            git -C "${WT_DIR}" push origin "HEAD:${REPORTS_BRANCH}"
          fi

          git worktree remove "${WT_DIR}" --force

      ############################################
      # Deploy (prod) ‚Äî inchang√©, seulement en release
      ############################################
      - name: Deploy SSR output to  server
        if: env.MODE != 'test'
        uses: easingthemes/ssh-deploy@main
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          ARGS: "-rltgoDzvO --delete"
          SOURCE: "frontend/.output"
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          TARGET: "/opt/open4goods/bin/latest/frontend-ssr"

      - name: Deploy reports (forced) to server
        uses: easingthemes/ssh-deploy@main
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          ARGS: "-rltgoDzvO --delete"
          SOURCE: "frontend/public/reports/"
          REMOTE_HOST: ${{ secrets.REMOTE_HOST }}
          REMOTE_USER: ${{ secrets.REMOTE_USER }}
          TARGET: "/opt/open4goods/bin/latest/frontend-ssr/.output/public/reports"

      - name: Publish frontend
        if: env.MODE != 'test'
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.REMOTE_HOST }}
          username: ${{ secrets.REMOTE_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: sh /opt/open4goods/bin/publish-frontend.sh prod

      ############################################
      # GitHub Release (tag only) + attach reports archive
      ############################################
      - name: üì¶ Package reports for GitHub Release
        if: env.MODE != 'test' && steps.meta.outputs.is_tag == 'true'
        shell: bash
        env:
          SAFE_VERSION: ${{ steps.meta.outputs.safe_version }}
        run: |
          set -euo pipefail
          tar -czf "reports-${SAFE_VERSION}.tgz" -C "frontend/public" "reports"

      - name: Create Release
        if: env.MODE != 'test' && steps.meta.outputs.is_tag == 'true'
        uses: mikepenz/action-gh-release@v1
        with:
          body_path: ${{ github.workspace }}/RELEASE-NOTES.md
          files: |
            LICENSE
            admin/target/admin-0.0.1-SNAPSHOT.jar
            api/target/api-0.0.1-SNAPSHOT.jar
            ui/target/ui-0.0.1-SNAPSHOT.jar
            target/staging/taglist/taglist.xml
            reports-${{ steps.meta.outputs.safe_version }}.tgz
